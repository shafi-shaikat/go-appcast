// Package provider holds the supported providers.
package provider

import (
	"regexp"

	"github.com/victorpopkov/go-appcast/appcaster"
)

// Providerer is the Provider interface.
type Providerer interface {
	appcaster.Providerer
}

// Provider holds different supported providers.
type Provider appcaster.Provider

const (
	// Unknown represents an unknown appcast provider.
	Unknown Provider = iota

	// Sparkle represents an RSS feed that is generated by the Sparkle
	// framework.
	Sparkle

	// SourceForge represents an RSS feed of the releases generated by the
	// SourceForge.
	SourceForge

	// GitHub represents an Atom feed of the releases generated by the GitHub.
	GitHub
)

var providerNames = [...]string{
	"-",
	"Sparkle RSS Feed",
	"SourceForge RSS Feed",
	"GitHub Atom Feed",
}

// GuessProviderByContent attempts to guess the supported provider from the
// passed content. By default returns Provider.Unknown.
func GuessProviderByContent(content []byte) Provider {
	regexSparkle := regexp.MustCompile(`(?s)(<rss.*xmlns:sparkle)|(?s)(<rss.*<enclosure)`)
	regexSourceForge := regexp.MustCompile(`(?s)(<rss.*xmlns:sf)|(?s)(<channel.*xmlns:sf)`)
	regexGitHub := regexp.MustCompile(`(?s)<feed.*<id>tag:github.com`)

	if regexSparkle.Match(content) {
		return Sparkle
	}

	if regexSourceForge.Match(content) {
		return SourceForge
	}

	if regexGitHub.Match(content) {
		return GitHub
	}

	return Unknown
}

// GuessProviderByContentString attempts to guess the supported provider from
// the passed content string. By default returns Provider.Unknown.
func GuessProviderByContentString(content string) Provider {
	return GuessProviderByContent([]byte(content))
}

// GuessProviderByUrl attempts to guess the supported provider from the passed
// URL. Only appcasts that are web-service specific can be guessed. By default
// returns Provider.Unknown.
func GuessProviderByUrl(url string) Provider {
	regexSourceForge := regexp.MustCompile(`.*sourceforge.net/projects/.*/rss`)
	regexGitHub := regexp.MustCompile(`.*github\.com/(?P<user>.*?)/(?P<repo>.*?)/releases\.atom`)

	if regexSourceForge.MatchString(url) {
		return SourceForge
	}

	if regexGitHub.MatchString(url) {
		return GitHub
	}

	return Unknown
}

// String returns the string representation of the Provider.
func (p Provider) String() string {
	return providerNames[p]
}
